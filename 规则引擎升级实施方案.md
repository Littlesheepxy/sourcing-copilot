# Boss直聘Sourcing智能助手 - 规则引擎升级实施方案

## 1. 当前问题分析

### 1.1 现有系统架构
目前系统中存在两套规则引擎：
- **权重评分规则引擎(FilterEngine)**: 实现于`shared/core/rules-engine/filter-engine.ts`，支持权重和具体规则类型
- **逻辑条件规则引擎(RulesEvaluator)**: 实现于`shared/core/rules-engine/evaluator.ts`，支持复杂逻辑条件

### 1.2 核心问题
- **UI与后端逻辑不匹配**：当前规则编辑器UI实现的是通用逻辑条件规则，后端主要使用权重评分规则引擎
- **缺失规则类型**：UI没有体现岗位、公司、关键词等特定规则类型
- **缺少权重设置**：UI没有权重设置功能
- **数据结构差异**：两种规则引擎使用不同的数据结构

## 2. 升级目标

根据PRD需求，规则引擎升级将实现：
1. 规则类型选择功能
2. 规则权重设置功能
3. 界面结构优化
4. 规则引擎评估机制优化
5. 统一两套规则引擎的数据结构和接口

## 3. 实施计划

### 3.1 架构调整

#### 3.1.1 数据结构统一
创建新的统一数据结构，支持两种规则引擎：

```typescript
// 统一的规则结构
interface UnifiedRule {
  id: string;
  type: 'position' | 'company' | 'keyword' | 'school' | 'education'; // 规则类型
  field: string;                  // 对应的字段
  operator: ConditionOperator;    // 操作符
  value: string | string[];       // 值(可以是单值或数组)
  weight: number;                 // 权重(0-100)
  enabled: boolean;               // 是否启用
  order?: number;                 // 顺序
}

// 统一的规则组结构
interface UnifiedRuleGroup {
  id: string;
  operator: LogicalOperator;      // AND/OR
  rules: (UnifiedRule | UnifiedRuleGroup)[]; // 规则或子规则组
  enabled: boolean;
  type?: 'group';                 // 标识这是一个规则组
}
```

#### 3.1.2 适配器设计
实现适配器，支持新旧数据结构转换：

```typescript
// shared/core/rules-engine/adapter.ts
class RulesAdapter {
  // 将统一规则转换为权重评分规则
  convertToFilterRules(unifiedRules: UnifiedRuleGroup): FilterRules {
    // 实现转换逻辑
  }
  
  // 将统一规则转换为逻辑条件规则
  convertToLogicRules(unifiedRules: UnifiedRuleGroup): RuleGroup {
    // 实现转换逻辑
  }
  
  // 将旧格式规则转换为统一规则
  convertToUnifiedRules(rules: FilterRules | RuleGroup): UnifiedRuleGroup {
    // 实现转换逻辑
  }
}
```

### 3.2 UI升级实施

#### 3.2.1 规则类型选择UI
修改`extension/modal/rule-modal.html`添加规则类型选择：

```html
<div class="rule-type-selector">
  <select class="rule-type-select">
    <option value="position">岗位规则</option>
    <option value="company">公司规则</option>
    <option value="keyword">关键词规则</option>
    <option value="school">学校规则</option>
    <option value="education">学历规则</option>
  </select>
  <div class="rule-type-indicator" data-type="position"></div>
</div>
```

#### 3.2.2 权重设置UI
为规则卡片添加权重设置滑块：

```html
<div class="rule-weight-container">
  <label>权重:</label>
  <input type="range" class="rule-weight-slider" min="0" max="100" value="50">
  <span class="rule-weight-value">50</span>
</div>
```

#### 3.2.3 规则卡片重设计
更新规则卡片布局，包含类型指示器、拖拽把手和权重设置：

```html
<div class="rule-card" data-rule-type="position">
  <div class="rule-card-header">
    <div class="rule-type-indicator"></div>
    <div class="drag-handle">≡</div>
    <div class="rule-title">岗位规则</div>
    <div class="rule-weight">权重: <span>50</span></div>
  </div>
  <div class="rule-card-body">
    <!-- 规则内容 -->
  </div>
</div>
```

#### 3.2.4 CSS样式更新
添加规则类型颜色编码和样式：

```css
/* 规则类型颜色 */
.rule-type-indicator[data-type="position"] { background-color: #4F46E5; }
.rule-type-indicator[data-type="company"] { background-color: #0EA5E9; }
.rule-type-indicator[data-type="keyword"] { background-color: #10B981; }
.rule-type-indicator[data-type="school"] { background-color: #F59E0B; }
.rule-type-indicator[data-type="education"] { background-color: #EC4899; }

/* 滑块样式 */
.rule-weight-slider {
  width: 200px;
  height: 6px;
  background: linear-gradient(to right, #eee, #10B981);
  border-radius: 3px;
}

/* 规则卡片样式 */
.rule-card {
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  margin-bottom: 10px;
  transition: transform 0.2s, box-shadow 0.2s;
}

.rule-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
```

### 3.3 JavaScript逻辑更新

#### 3.3.1 规则类型处理
更新`extension/dist/modal/rule-modal.js`:

```javascript
// 规则类型处理
function handleRuleTypeChange(event) {
  const ruleCard = event.target.closest('.rule-card');
  const type = event.target.value;
  
  // 更新规则类型指示器
  const indicator = ruleCard.querySelector('.rule-type-indicator');
  indicator.dataset.type = type;
  
  // 更新规则标题
  const title = ruleCard.querySelector('.rule-title');
  title.textContent = ruleTypeLabels[type];
  
  // 根据规则类型切换权重滑块可用性
  const weightSlider = ruleCard.querySelector('.rule-weight-slider');
  weightSlider.disabled = type !== 'keyword';
  
  // 保存规则类型到数据模型
  const ruleId = ruleCard.dataset.ruleId;
  updateRuleProperty(ruleId, 'type', type);
}
```

#### 3.3.2 权重处理
添加权重处理逻辑：

```javascript
// 权重滑块处理
function handleWeightChange(event) {
  const ruleCard = event.target.closest('.rule-card');
  const weightValue = ruleCard.querySelector('.rule-weight span');
  const value = event.target.value;
  
  // 更新显示值
  weightValue.textContent = value;
  
  // 更新滑块背景颜色
  const percent = value / 100;
  event.target.style.background = 
    `linear-gradient(to right, #10B981 ${percent * 100}%, #eee ${percent * 100}%)`;
  
  // 保存权重到数据模型
  const ruleId = ruleCard.dataset.ruleId;
  updateRuleProperty(ruleId, 'weight', parseInt(value));
}
```

#### 3.3.3 数据结构适配
添加数据结构转换函数：

```javascript
// 将UI规则转换为统一规则格式
function convertToUnifiedRules() {
  // 实现从UI收集规则数据并转换为统一格式
}

// 将统一规则加载到UI
function loadUnifiedRulesToUI(unifiedRules) {
  // 实现将统一格式规则加载到UI显示
}
```

### 3.4 后端逻辑更新

#### 3.4.1 创建统一规则引擎
在`shared/core/rules-engine/unified-engine.ts`中实现统一规则引擎：

```typescript
// 统一规则引擎
export class UnifiedRulesEngine {
  private adapter: RulesAdapter;
  private filterEngine: FilterEngine;
  private logicEngine: RulesEvaluator;
  
  constructor() {
    this.adapter = new RulesAdapter();
    this.filterEngine = new FilterEngine();
    this.logicEngine = new RulesEvaluator();
  }
  
  // 评估候选人
  evaluateCandidate(candidate: CandidateData, rules: UnifiedRuleGroup): UnifiedEvaluationResult {
    // 将统一规则转换为具体规则格式
    const filterRules = this.adapter.convertToFilterRules(rules);
    const logicRules = this.adapter.convertToLogicRules(rules);
    
    // 分别使用两种引擎评估
    const filterResult = this.filterEngine.evaluateCandidate(candidate, filterRules);
    const logicResult = this.logicEngine.evaluateRules({data: candidate}, logicRules);
    
    // 整合评估结果
    return this.combineResults(filterResult, logicResult);
  }
  
  // 整合两种引擎的评估结果
  private combineResults(filterResult, logicResult): UnifiedEvaluationResult {
    // 实现结果整合逻辑
  }
}
```

#### 3.4.2 更新API接口
更新后台服务消息处理：

```typescript
// extension/background/index.ts
import { UnifiedRulesEngine } from '../../shared/core/rules-engine/unified-engine';

// 初始化统一规则引擎
const unifiedEngine = new UnifiedRulesEngine();

// 处理评估请求
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.type === 'evaluateResume') {
    try {
      const result = unifiedEngine.evaluateCandidate(
        message.resumeData,
        message.rules
      );
      sendResponse({ result });
    } catch (error) {
      sendResponse({ error: error.message });
    }
    return true;
  }
  // ...
});
```

## 4. 具体实施步骤

### 4.1 第一阶段: 架构设计与准备
- [ ] 定义统一规则数据结构
- [ ] 设计规则适配器
- [ ] 规划UI组件结构
- [ ] 确定CSS样式方案

### 4.2 第二阶段: UI组件实现
- [ ] 更新规则编辑器HTML结构
- [ ] 实现规则类型选择组件
- [ ] 实现权重设置滑块
- [ ] 重设计规则卡片布局
- [ ] 更新CSS样式

### 4.3 第三阶段: 逻辑实现
- [ ] 实现规则类型处理逻辑
- [ ] 实现权重处理逻辑
- [ ] 实现规则数据结构转换
- [ ] 实现统一规则引擎
- [ ] 更新后台服务

### 4.4 第四阶段: 测试与优化
- [ ] 单元测试
- [ ] 集成测试
- [ ] UI/UX测试
- [ ] 性能优化

## 5. 进展记录

### 2023-08-01
- 项目启动
- 完成问题分析和升级目标确定

### 2023-08-02
- 完成数据结构设计
- 开始适配器实现

### 2023-08-03
- 完成UI原型设计
- 开始HTML/CSS更新

### 2023-08-04
- ✅ 完成统一规则数据结构定义(`shared/core/rules-engine/types.ts`)
- ✅ 实现规则适配器(`shared/core/rules-engine/adapter.ts`)
- ✅ 实现统一规则引擎(`shared/core/rules-engine/unified-engine.ts`)
- ✅ 更新规则编辑器HTML结构(`extension/modal/rule-modal.html`)
- ✅ 创建规则编辑器CSS样式(`extension/styles/rule-modal.css`)

### 待完成任务
1. 更新规则编辑器JavaScript逻辑(`extension/dist/modal/rule-modal.js`)
   - 处理规则类型选择
   - 处理权重设置
   - 实现数据结构转换
   - 处理表单提交和保存逻辑

2. 集成测试
   - 测试规则编辑器UI
   - 测试规则评估功能
   - 测试规则转换功能

## 下一步计划
1. 实现规则编辑器JavaScript逻辑
2. 更新后台服务消息处理
3. 进行集成测试和调试
4. 编写用户文档和使用指南

## 6. 注意事项

1. **兼容性考虑**：确保升级后的规则引擎能够兼容已有的规则数据
2. **渐进式实现**：先实现核心功能，逐步添加高级特性
3. **用户体验优先**：确保UI操作流畅，提供即时反馈
4. **性能监控**：关注规则评估性能，尤其是处理大量候选人数据时
5. **文档更新**：同步更新开发文档和用户指南

## 7. 资源与参考

- [原始规则引擎文档](rule-engine.md)
- [规则引擎升级PRD](规则引擎升级PRD.md)
- [UI设计规范](https://www.figma.com/file/xxx/rule-engine-ui)

## 8. 下一步工作计划

### 8.1 关键文件修改清单

| 文件路径 | 修改内容 | 优先级 |
|---------|---------|-------|
| `shared/core/rules-engine/types.ts` | 添加统一规则数据结构定义 | 高 |
| `shared/core/rules-engine/adapter.ts` | 创建新文件，实现规则适配器 | 高 |
| `shared/core/rules-engine/unified-engine.ts` | 创建新文件，实现统一规则引擎 | 高 |
| `extension/modal/rule-modal.html` | 更新UI结构，添加规则类型和权重设置 | 中 |
| `extension/dist/modal/rule-modal.js` | 更新逻辑处理，支持规则类型和权重 | 中 |
| `extension/styles/rule-modal.css` | 更新样式，实现新的UI设计 | 中 |
| `extension/background/index.ts` | 更新消息处理，使用统一规则引擎 | 低 |

### 8.2 开发里程碑

| 里程碑 | 计划完成时间 | 交付物 |
|-------|------------|-------|
| 数据结构与适配器开发 | 2023-08-10 | 统一数据结构、适配器实现 |
| UI组件开发 | 2023-08-20 | 规则类型选择、权重设置UI |
| 统一规则引擎开发 | 2023-08-30 | 规则评估引擎整合 |
| 端到端集成测试 | 2023-09-05 | 测试报告、问题修复 |
| 正式发布 | 2023-09-10 | 升级后的规则引擎系统 |

### 8.3 需要协调的资源

1. **前端开发资源**：负责UI组件实现和交互逻辑
2. **后端开发资源**：负责规则引擎核心逻辑和数据结构
3. **测试资源**：负责端到端测试和验证
4. **设计资源**：提供UI设计细节和交互规范

### 8.4 风险管理

| 风险 | 影响 | 可能性 | 缓解措施 |
|-----|-----|-------|---------|
| 新旧数据结构兼容性问题 | 高 | 中 | 开发数据迁移工具，保留旧版本兼容性 |
| UI性能下降 | 中 | 低 | 进行性能测试，优化渲染逻辑 |
| 规则评估逻辑复杂性增加 | 中 | 高 | 增加单元测试覆盖率，设计明确的评估流程 |
| 用户习惯改变 | 低 | 高 | 提供新版本使用指南和视频教程 | 